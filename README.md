# ArtemisFgComposer

一款用于 **Artemis 视觉小说引擎** 的立绘批量合成工具，可以从PNG元数据或 Lua 脚本读取坐标信息，自动根据文件名规则对图片进行分类，组合生成所有的可能结果并批量合成，且支持位置信息回写用于二次合成。

## 使用方法

### 基本语法

```cmd
ArtemisFgComposer.exe [选项] <输入目录>
```

### 命令行选项

| 选项                | 简写        | 描述                                           |
| :------------------ | :---------- | :--------------------------------------------- |
| `--help`            | `-h`        | 显示帮助信息                                   |
| `--verbose`         | `-v`        | 输出详细日志                                   |
| `--write-pos-back`  | `-w`        | 将位置信息写回文件以二次合成                   |
| `--lua-path <路径>` | `-l <路径>` | 含有坐标信息的Lua脚本路径                      |
| `--output <路径>`   | `-o <路径>` | 输出目录，默认保存在输入目录同级的output文件夹 |
| `<输入目录>`        |             | 包含立绘部件的输入目录                         |

### 使用示例

#### 命令行

```cmd
ArtemisFgComposer.exe ./input

ArtemisFgComposer.exe --output ./output ./input

ArtemisFgComposer.exe -v -w -l ./list_windows.tbl ./input

ArtemisFgComposer.exe --verbose --write-pos-back --lua-path ./coordinates.lua --output ./results ./character_parts
```

#### 拖放

将待合成文件夹直接拖放至.exe上，除输入目录外其余参数均为默认

## 文件命名规则

工具根据以下规则对图片文件进行分类：

### 组分类规则

- 文件名匹配正则表达式：`([a-z]\d{4})`
- 使用文件名首字母作为组名（a-z）

### 部件分类规则

| 部件类型 | 正则表达式                        | 描述         |
| :------- | :-------------------------------- | :----------- |
| `base`   | `^[a-z]{3}_[a-z0-9]{2}[a-z]\d{4}` | 基础立绘部件 |
| `face`   | `^[a-z]\d{2}[0-8]\d`              | 面部表情部件 |
| `other`  | `^[a-z]\d{2}9\d`                  | 其他装饰部件 |

## 输入目录结构

输入目录应包含一组或多组立绘部件PNG文件：

```
no/
├── chr_noa0001.png
├── a0010.png
├── a0020.png
├── a9010.png
├── chr_nob0001.png
├── b0010.png
└── b9010.png
```

## 输出结果

工具会在输出目录生成所有可能的组合：

```
no_output/
├── chr_noa0001_a9010.png
├── chr_noa0001_a9010.png
├── chr_nob0001_b9010.png
└── ...
```

## Lua坐标文件格式

如果使用Lua坐标文件，文件内容应遵循以下格式：

```lua
fgpos = {
    tak_bca = {
        a0001 = {x = 457, y = 192},
        a0099 = {x = 464, y = 164},
        tak_bca0000 = {x = 341, y = 113},
        tak_bca0502 = {x = 331, y = 113},
    },
    tak_z2b = {
        b0001 = {x = 329, y = 226},
        b0099 = {x = 351, y = 158},
        tak_z2b0000 = {x = 177, y = 14},
        tak_z2b0502 = {x = 101, y = 14},
    },
}
```

**不建议更改立绘目录内所有文件夹的名称，否则可能会解析失败**

## 测试结果说明

目前已尝试对多款游戏的部分立绘进行测试，以下为具体适配情况、现存局限及后续优化方向：

###  适用游戏场景

#### 元数据坐标

此类游戏的立绘坐标信息直接存储于图片元数据中，理论上可实现较好的合成效果：

- **保健室のセンセーとゴスロリの校医 / 保健室的老师与哥特萝莉校医**
- **ホーリーアンデッド / 圣女不死心**
  注：在合成里面笨蛋王子的立绘时，遇到了部件位置溢出基础立绘而导致截断的问题，已作出相应处理避免了类似情况

- **ハミダシクリエイティブ凸 / 常轨脱离Creative凸**
- **FLIP＊FLOP ～RAMBLING OVERRUN～**
- **セレクトオブリージュ / 天选庶民的真命之选**
- **サクラノ刻 / 樱之刻**

> [!CAUTION]
>
> 实际合成时，部分装饰性部件可能为「必需项」（影响立绘完整性），也可能为「可选项」（仅补充细节）。
> 当前工具默认将所有部件判定为必需项，若需排除可选项，可手动删除对应文件后重新执行合成。

#### Lua表坐标

此类游戏的立绘坐标未存储于图片元数据，而是封装在特定 Lua 脚本中。可通过解析 Lua 表实现合成，目前已适配：

- **アイベヤ / 同居女友**

坐标信息位于 `root.pfs.002` 封包内的 `system\table\list_windows.tbl` 中 —— 也正是根据这个添加了 Lua 表解析功能

注：目前仅验证过该游戏的 Lua 表格式，暂无法保证适配其他同类型游戏的 Lua 表结构

### 效果不佳的场景

在下面这些游戏中的表现较为失败

- **流星ワールドアクター / 流星世界演绎者**

选取了一个角色的立绘合成，发现本应是独立的两个组分到一起了，出现了很多不合理的组合

- **たねつみの歌 / 播种之谣**

合成阳子的立绘时，`a0089.png`（实际为装饰部件）被当前分类规则误判为「表情图层」，导致分类偏差

如果能接受的话可尝试将该文件重命名使符合相应规则（如 `a0099.png` ）后再进行合成

### 后续计划

尝试增加相应的命令行选项处理「可选项」情况

可能会导出分类配置文件，允许用户自定义图层分类规则

## **免责声明**

本工具仅供学习和研究使用，请勿用于商业用途。任何通过本工具获得的游戏资源，请遵守相关游戏的版权声明，不得随意传播和商用。
